const dotenv=require("dotenv").config(),compression=require("compression"),express=require("express"),bodyParser=require("body-parser"),_lodash=require("lodash"),ejs=require("ejs"),country=require("country-list"),currency=require("currency-codes"),cache=require("apicache").middleware,usersDB=require(__dirname+"/models/users.js"),companyCode=require(__dirname+"/models/companycode.js"),accType=require(__dirname+"/models/gl-accounttype.js"),glAcc=require(__dirname+"/models/glAccount.js"),vendor=require(__dirname+"/models/vendor.js"),customer=require(__dirname+"/models/customer.js"),glSeries=require(__dirname+"/models/gl-series.js"),glTransaction=require(__dirname+"/models/glTransaction.js"),docSequence=require(__dirname+"/models/documentSequence.js"),userPrivilege=require(__dirname+"/models/privilege.js"),controlPeriod=require(__dirname+"/models/control.js"),flash=require("connect-flash"),mongoose=require("mongoose"),session=require("express-session"),passport=require("passport"),app=express();app.set("view engine","ejs"),app.use(express.static("public")),app.use(bodyParser.urlencoded({extended:!0})),app.use(bodyParser.json()),app.use(session({secret:process.env.SECRET,resave:!1,saveUninitialized:!1})),app.use(passport.initialize()),app.use(passport.session()),app.use(flash()),app.use(compression()),mongoose.connect(process.env.DATABASE_URI,{useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1,autoIndex:!0}),mongoose.set("useCreateIndex",!0),mongoose.set("runValidators",!0);let returnTo="",country_names=country.getNames(),currency_list=currency.codes();app.get("/ajax",function(e,o){o.render("ajax",{title:"An Ajax Example",quote:"AJAX is great!"})}),app.post("/ajax",function(e,o){o.render("ajax",{title:"An Ajax Example",quote:e.body.quote})}),app.get("/flash",function(e,o){e.flash("info","Hi there!"),o.redirect("/")}),app.get("/",function(e,o){e.isAuthenticated()?o.render("index",{user:e.user}):(returnTo=e.url,o.redirect("/login"))}),app.get("/login",function(e,o){const r=e.flash().error||[];o.render("login",{errors:r})}),app.post("/login",function(e,o){const r=new usersDB.User({username:e.body.username,password:e.body.password});e.login(r,function(r){r?console.log(r):passport.authenticate("local",{failureRedirect:"/login",failureFlash:!0})(e,o,function(){o.redirect(returnTo||"/"),returnTo=""})})}),app.get("/logout",function(e,o){o.setHeader("Cache-control","no-store"),e.logout(),o.redirect("/")}),app.get("/db",async function(e,o){companyCode_list=await companyCode.getCompanyCode(),o.send(companyCode_list)}),app.route("/ud-dashboard").get(function(e,o){e.isAuthenticated()?"admin"===e.user.position?o.render("ud-dashboard"):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).post().delete(),app.route("/us-create").get(async function(e,o){e.isAuthenticated()?"admin"===e.user.position?(user_List=await usersDB.getUser(),privilege_List=await userPrivilege.getPrivilege(),companyCode_list=await companyCode.getCompanyCode(),o.render("user",{companyCodes:companyCode_list,privilegeList:privilege_List,userList:user_List,user:e.user})):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){e.isAuthenticated()?"admin"===e.user.position?usersDB.User.register({username:e.body.username},e.body.password,function(r,t){r?(console.log(r),o.redirect("/us-create")):(t.fullname=e.body.fullname,t.position=e.body.position,t.companyCode=e.body.companyCode,t.save(function(e){var r={};e?(r.redirect=!1,r.errorMessage=e,o.send(r)):(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/us-create",r.message="User created!",o.send(r))}))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={id:e.body.userId,password:e.body.password,userValues:{fullname:e.body.fullname,position:e.body.position,companyCode:e.body.companyCode}};e.isAuthenticated()?"admin"===e.user.position?usersDB.updateUser(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/us-create",r.message="User updated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(),app.route("/us-privilege").get(async function(e,o){if(e.isAuthenticated())if("admin"===e.user.position){let r=await userPrivilege.getPrivilege();o.render("privileges",{privilegeList:r,user:e.user})}else o.send("Unauthorized!");else returnTo=e.url,o.redirect("/login")}).post(function(e,o){const r=new userPrivilege.privilege({position:e.body.position,park:e.body.park,post:e.body.post});e.isAuthenticated()?"admin"===e.user.position?userPrivilege.addPrivilege(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/us-privilege",r.message="Position Privilege created!",o.send(r)):"0"==e?(r.redirect=!1,r.errorMessage="Duplication error!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={id:e.body.positionID,privilegeValues:{position:e.body.position,park:e.body.park,post:e.body.post}};e.isAuthenticated()?"admin"===e.user.position?userPrivilege.updatePrivilege(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/us-privilege",r.message="Position Privilege updated!",o.send(r)):"0"==e?(r.redirect=!1,r.errorMessage="Duplication Error!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(),app.route("/gn-companycode").get(async function(e,o){if(e.isAuthenticated())if("admin"===e.user.position){let r=await companyCode.getCompanyCode();o.render("companycode",{countries:country_names,currencies:currency_list,companyCodes:r,user:e.user})}else o.send("Unauthorized!");else returnTo=e.url,o.redirect("/login")}).post(function(e,o){e.body.company_codeID;let r=e.body.company_code,t=e.body.company_name,n=e.body.company_country,c=e.body.company_currency;const s=new companyCode.cCode({code:r,country:n,company:t,currency:c});e.isAuthenticated()?"admin"===e.user.position?companyCode.addCompanyCode(s,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-companycode",r.message="Company Code created!",o.send(r)):"0"==e?(r.redirect=!1,o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).put().patch(function(e,o){let r=e.body.company_codeID,t=e.body.company_code,n=e.body.company_name,c=e.body.company_country,s=e.body.company_currency;const d=new companyCode.cCode({_id:r,code:t,company:n,country:c,currency:s});e.isAuthenticated()?"admin"===e.user.position?companyCode.updateCompanyCode(d,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-companycode",r.message="Company Code updated!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Company Code exists!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){let r=e.body.company_codeID;e.isAuthenticated()?"admin"===e.user.position?companyCode.deleteCompanyCode(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-companycode",r.message="Company Code deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/gn-control").get(async function(e,o){e.isAuthenticated()?"admin"===e.user.position?(controlPeriod_List=await controlPeriod.getControlPeriod(),companyCode_list=await companyCode.getCompanyCode(),o.render("control",{controlPeriods:controlPeriod_List,companyCodes:companyCode_list,user:e.user})):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){const r=new controlPeriod.controlPeriod({accountType:e.body.accountType,companyCode:e.body.companyCode,fromAccount:e.body.fromAccount,toAccount:e.body.toAccount,fromPeriod:e.body.fromPeriod,toPeriod:e.body.toPeriod,controlYear:e.body.controlYear,status:e.body.status});e.isAuthenticated()?"admin"===e.user.position?controlPeriod.addControlPeriod(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-control",r.message="Control created!",o.send(r)):"0"==e?(r.redirect=!1,o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={periodId:e.body.periodID,periodValues:{accountType:e.body.accountType,companyCode:e.body.companyCode,fromAccount:e.body.fromAccount,toAccount:e.body.toAccount,fromPeriod:e.body.fromPeriod,toPeriod:e.body.toPeriod,controlYear:e.body.controlYear,status:e.body.status}};e.isAuthenticated()?"admin"===e.user.position?controlPeriod.updateControlPeriod(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-control",r.message="Control updated!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Control already exist!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r=e.body.periodID;e.isAuthenticated()?"admin"===e.user.position?controlPeriod.deleteControlPeriod(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gn-control",r.message="Control deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/gl-accounttype").get(async function(e,o){if(e.isAuthenticated())if("admin"===e.user.position){let r=await accType.getAccountType();o.render("accounttype",{accountTypes:r,user:e.user})}else o.send("Unauthorized!");else returnTo=e.url,o.redirect("/login")}).post(function(e,o){const r=new accType.accountType({accountType:e.body.account_type,rangeFrom:e.body.accountTypeRangeFrom,rangeTo:e.body.accountTypeRangeTo,accountGroup:[]});e.isAuthenticated()?"admin"===e.user.position?accType.addAccountType(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accounttype",r.message="Account Type created!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Account Type exists!",o.send(r)):"01"==e?(r.redirect=!1,r.message="Range already in use.",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={_id:e.body.account_typeID,accountTypeValues:{accountType:e.body.account_type,rangeFrom:e.body.accountTypeRangeFrom,rangeTo:e.body.accountTypeRangeTo}};e.isAuthenticated()?"admin"===e.user.position?accType.updateAccountType(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accounttype",r.message="Account Type updated!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Account Type exists!",o.send(r)):"01"==e?(r.redirect=!1,r.message="Range already in use.",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){let r=e.body.account_typeID;e.isAuthenticated()?"admin"===e.user.position?accType.deleteAccountType(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accounttype",r.message="Account Type deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/gl-accountgroup").get(function(e,o){e.isAuthenticated()?"admin"===e.user.position?accType.getAccountGroup(function(r){o.render("accountgroup",{accounts:r,user:e.user})}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){let r=e.body.accountGrouptypeID,t=e.body.accountGroupName;const n={accountTypeID:r,accountGroup:t,accountGroupValues:{accountGroup:t}};e.isAuthenticated()?"admin"===e.user.position?accType.addAccountGroup(n,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accountgroup",r.message="Account Group created!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Account Group Exists!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={accountGrouptypeID:e.body.accountGrouptypeID,accountGroupID:e.body.accountGroupID,accountGroupValues:{accountGroup:e.body.accountGroupName}};e.isAuthenticated()?"admin"===e.user.position?accType.updateAccountGroup(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accountgroup",r.message="Account Group updated!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Account Group Exists!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r={accountGrouptypeID:e.body.accountGrouptypeID,accountGroupID:e.body.accountGroupID};e.isAuthenticated()?"admin"===e.user.position?accType.deleteAccountGroup(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-accountgroup",r.message="Account Group deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/gl-series").get(async function(e,o){if(e.isAuthenticated())if("admin"===e.user.position){var r=await glSeries.getGlSeries();o.render("gl-series",{glSeriesList:r,user:e.user})}else o.send("Unauthorized!");else returnTo=e.url,o.redirect("/login")}).post(function(e,o){const r=new glSeries.glSeries({account:e.body.accountGl,series:e.body.seriesGl});e.isAuthenticated()?"admin"===e.user.position?glSeries.addGlSeries(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-series",r.message="GL Series created!",o.send(r)):"0"==e?(r.redirect=!1,r.message="Series already in use/Account series exists!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={account:e.body.accountGl,series:e.body.seriesGl};e.isAuthenticated()?"admin"===e.user.position?glSeries.updateGlSeries(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-series",r.message="GL Series updated!",o.send(r)):"0"==e&&(r.redirect=!1,r.message="Series already in use/Account series exists!",o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r=e.body.glSeries_id;e.isAuthenticated()?"admin"===e.user.position?glSeries.deleteGlSeries(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-series",r.message="GL Series deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/gl-sequence").get(async function(e,o){if(e.isAuthenticated())if("admin"===e.user.position){var r=await companyCode.getCompanyCode(),t=await docSequence.getDocSequence();o.render("doc-seq",{docSequenceList:t,companycodeList:r,user:e.user})}else o.send("Unauthorized!");else returnTo=e.url,o.redirect("/login")}).post(function(e,o){var r=e.body.year;e.isAuthenticated()?"admin"===e.user.position?docSequence.addDocSequence(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/gl-sequence",r.message="Document Sequence generated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Error!",o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(),app.route("/main-list").get(async function(e,o){var r={};r.companyCode_list=await companyCode.getCompanyCode(),r.accountType_list=await accType.getAccountType(),r.glAccount_list=await glAcc.getGlAccount(),r.vendor_List=await vendor.getVendor(),r.customer_List=await customer.getCustomer(),r.glSeries_List=await glSeries.getGlSeries(),r.glTransaction_List=await glTransaction.getGlTransaction(),r.docSequence_List=await docSequence.getDocSequence(),r.privilege_List=await userPrivilege.getPrivilege(),r.controlPeriod_List=await controlPeriod.getControlPeriod(),r.user_List=await usersDB.getUser(),r.user=e.user,o.send(r)}),app.get("/get-accountType_list",async(e,o)=>{const r=await accType.getAccountType();o.send(r)}),app.get("/get-vendor_list",async(e,o)=>{const r=await vendor.getVendor();o.send(r)}),app.get("/get-customer_list",async(e,o)=>{const r=await customer.getCustomer();o.send(r)}),app.get("/get-glaccount_list",async(e,o)=>{const r=await glAcc.getGlAccount();o.send(r)}),app.get("/get-controlperiod_list",async(e,o)=>{const r=await controlPeriod.getControlPeriod();o.send(r)}),app.get("/get-accounts_list",async(e,o)=>{var r={};r.accountType_list=await accType.getAccountType(),r.glAccount_list=await glAcc.getGlAccount(),o.send(r)}),app.get("/get-glUser_list",async(e,o)=>{var r={};r.user=e.user,r.glAccount_list=await glAcc.getGlAccount(),r.companyCode_list=await companyCode.getCompanyCode(),o.send(r)}),app.get("/get-masterdata_list",async(e,o)=>{var r={};r.companyCode_list=await companyCode.getCompanyCode(),r.glAccount_list=await glAcc.getGlAccount(),r.customer_List=await customer.getCustomer(),r.vendor_List=await vendor.getVendor(),o.send(r)}),app.get("/get-search_list",async(e,o)=>{var r={};r.user=e.user,r.glAccount_list=await glAcc.getGlAccount(),r.glTransaction_List=await glTransaction.getGlTransaction(),r.user_List=await usersDB.getUser(),o.send(r)}),app.get("/get-changecompanycode_list",async(e,o)=>{var r={};r.glAccount_list=await glAcc.getGlAccount(),r.customer_List=await customer.getCustomer(),r.vendor_List=await vendor.getVendor(),o.send(r)}),app.route("/md-gl").get(async function(e,o){e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),accountType_list=await accType.getAccountType(),glAccount_list=await glAcc.getGlAccount(),o.render("md-gl",{companyCodes:companyCode_list,user:e.user,accType:accountType_list,glAccounts:glAccount_list})):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){const r=new glAcc.glAccount({glAccount:e.body.glAccount,glName:e.body.glName,companyCode:e.body.companyCode,accountCurrency:e.body.accountCurrency,accountType:e.body.accountType,taxCategory:e.body.taxCategory,accountGroup:e.body.accountGroup,descShort:e.body.descShort,descLong:e.body.descLong});e.isAuthenticated()?"admin"===e.user.position?glAcc.addGlAccount(r,function(e){var r={};console.log(e),"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-gl",r.message="GL Account Created!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="GL Account Exists!",o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={glAccount:e.body.glAccount,glAccountValues:{glName:e.body.glName,companyCode:e.body.companyCode,accountCurrency:e.body.accountCurrency,accountType:e.body.accountType,taxCategory:e.body.taxCategory,accountGroup:e.body.accountGroup,descShort:e.body.descShort,descLong:e.body.descLong}};e.isAuthenticated()?"admin"===e.user.position?glAcc.updateGlAccount(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-gl",r.message="GL Account updated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r=e.body.glAccount;e.isAuthenticated()?"admin"===e.user.position?glAcc.deleteGlAccount(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-gl",r.message="GL Account deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/md-vendor").get(async function(e,o){e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),accountType_list=await accType.getAccountType(),vendor_list=await vendor.getVendor(),o.render("md-vendor",{vendors:vendor_list,countries:country_names,currencies:currency_list,companyCodes:companyCode_list,user:e.user})):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){const r=new vendor.vendor({vendorCode:e.body.vendorCode,vendorName:e.body.vendorName,vendorCompanyCode:e.body.vendorCompanyCode,vendorCurrency:e.body.vendorCurrency,vendorTaxCategory:e.body.vendorTaxCategory,vendorPaymentTerm:e.body.vendorPaymentTerm,vendorTax:e.body.vendorTax,vendorRecon:e.body.vendorRecon,vendorStreet:e.body.vendorStreet,vendorCity:e.body.vendorCity,vendorCountry:e.body.vendorCountry,vendorPostalCode:e.body.vendorPostalCode,vendorTelephone:e.body.vendorTelephone,vendorEmail:e.body.vendorEmail,vendorWebsite:e.body.vendorWebsite});e.isAuthenticated()?"admin"===e.user.position?vendor.addVendor(r,function(e){var r={};console.log(e),"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-vendor",r.message="Vendor Created!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Vendor Code Exists!",o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={vendorCode:e.body.vendorCode,vendorValues:{vendorName:e.body.vendorName,vendorCompanyCode:e.body.vendorCompanyCode,vendorCurrency:e.body.vendorCurrency,vendorTaxCategory:e.body.vendorTaxCategory,vendorPaymentTerm:e.body.vendorPaymentTerm,vendorTax:e.body.vendorTax,vendorRecon:e.body.vendorRecon,vendorStreet:e.body.vendorStreet,vendorCity:e.body.vendorCity,vendorCountry:e.body.vendorCountry,vendorPostalCode:e.body.vendorPostalCode,vendorTelephone:e.body.vendorTelephone,vendorEmail:e.body.vendorEmail,vendorWebsite:e.body.vendorWebsite}};e.isAuthenticated()?"admin"===e.user.position?vendor.updateVendor(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-vendor",r.message="Vendor updated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r=e.body.vendorCode;e.isAuthenticated()?"admin"===e.user.position?vendor.deleteVendor(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-vendor",r.message="Vendor deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.route("/md-customer").get(async function(e,o){e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),customer_list=await customer.getCustomer(),o.render("md-customer",{countries:country_names,currencies:currency_list,companyCodes:companyCode_list,customers:customer_list,user:e.user})):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){const r=new customer.customer({customerCode:e.body.customerCode,customerName:e.body.customerName,customerCompanyCode:e.body.customerCompanyCode,customerCurrency:e.body.customerCurrency,customerTaxCategory:e.body.customerTaxCategory,customerPaymentTerm:e.body.customerPaymentTerm,customerTax:e.body.customerTax,customerRecon:e.body.customerRecon,customerStreet:e.body.customerStreet,customerCity:e.body.customerCity,customerCountry:e.body.customerCountry,customerPostalCode:e.body.customerPostalCode,customerTelephone:e.body.customerTelephone,customerEmail:e.body.customerEmail,customerWebsite:e.body.customerWebsite});e.isAuthenticated()?"admin"===e.user.position?customer.addCustomer(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-customer",r.message="Customer Created!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Customer Code Exists!",o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={customerCode:e.body.customerCode,customerValues:{customerName:e.body.customerName,customerCompanyCode:e.body.customerCompanyCode,customerCurrency:e.body.customerCurrency,customerTaxCategory:e.body.customerTaxCategory,customerPaymentTerm:e.body.customerPaymentTerm,customerTax:e.body.customerTax,customerRecon:e.body.customerRecon,customerStreet:e.body.customerStreet,customerCity:e.body.customerCity,customerCountry:e.body.customerCountry,customerPostalCode:e.body.customerPostalCode,customerTelephone:e.body.customerTelephone,customerEmail:e.body.customerEmail,customerWebsite:e.body.customerWebsite}};e.isAuthenticated()?"admin"===e.user.position?customer.updateCustomer(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-customer",r.message="Customer updated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}).delete(function(e,o){const r=e.body.customerCode;e.isAuthenticated()?"admin"===e.user.position?customer.deleteCustomer(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/md-customer",r.message="Customer deleted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=err,o.send(r))}):o.send("Unauthorized!"):(returnTo=e.url,o.redirect("/login"))}),app.get("/md-taxrate",function(e,o){o.send("Under maintenance")}),app.route("/ac-gl").get(async function(e,o){o.setHeader("Cache-control","private, max-age=60"),e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),glAccount_list=await glAcc.getGlAccount(),customer_list=await customer.getCustomer(),o.render("ac-gl",{user:e.user,companyCodes:companyCode_list,glAccounts:glAccount_list,customers:customer_list})):(returnTo=e.url,o.redirect("/login"))}).post(async function(e,o){const r={account:e.body.account,companyCode:e.body.companyCode,docYear:2021},t=await docSequence.getDocNumber(r),n=new glTransaction.glTransaction({documentNumber:t,documentDate:e.body.documentDate,postingDate:e.body.postingDate,reference:e.body.reference,amount:e.body.amount,text:e.body.text,companyCode:e.body.companyCode,companyName:e.body.companyName,currency:e.body.currency,debit:e.body.debit,credit:e.body.credit,transactionType:e.body.transactionType,status:"parked",parker:e.user._id,poster:"",jEntry:e.body.jlEntry});e.isAuthenticated()?glTransaction.addGLTransaction(n,function(e){var r={};"1"==e.status?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/ac-gl",r.message="Document Number: "+e.docNumber+" saved!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Error!",o.send(r))}):(returnTo=e.url,o.redirect("/login"))}).patch().delete(),app.route("/ar-ci").get(async function(e,o){o.setHeader("Cache-control","private"),e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),glAccount_list=await glAcc.getGlAccount(),o.render("ar-ci",{user:e.user,companyCodes:companyCode_list,glAccounts:glAccount_list})):(returnTo=e.url,o.redirect("/login"))}).post(async function(e,o){const r={account:e.body.account,companyCode:e.body.companyCode,docYear:2021},t=await docSequence.getDocNumber(r),n=new glTransaction.glTransaction({documentNumber:t,documentDate:e.body.documentDate,postingDate:e.body.postingDate,reference:e.body.reference,amount:e.body.amount,text:e.body.text,companyCode:e.body.companyCode,companyName:e.body.companyName,currency:e.body.currency,debit:e.body.debit,credit:e.body.credit,transactionType:e.body.transactionType,status:"parked",parker:e.user._id,poster:"",jEntry:e.body.jlEntry});e.isAuthenticated()?glTransaction.addGLTransaction(n,function(e){var r={};"1"==e.status?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/ar-ci",r.message="Document Number: "+e.docNumber+" saved!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Error!",o.send(r))}):(returnTo=e.url,o.redirect("/login"))}).patch().delete(),app.route("/ap-vi").get(async function(e,o){o.setHeader("Cache-control","private"),e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),glAccount_list=await glAcc.getGlAccount(),o.render("ap-vi",{user:e.user,companyCodes:companyCode_list,glAccounts:glAccount_list})):(returnTo=e.url,o.redirect("/login"))}).post(async function(e,o){const r={account:e.body.account,companyCode:e.body.companyCode,docYear:2021},t=await docSequence.getDocNumber(r),n=new glTransaction.glTransaction({documentNumber:t,documentDate:e.body.documentDate,postingDate:e.body.postingDate,reference:e.body.reference,amount:e.body.amount,text:e.body.text,companyCode:e.body.companyCode,companyName:e.body.companyName,currency:e.body.currency,debit:e.body.debit,credit:e.body.credit,transactionType:e.body.transactionType,status:"parked",parker:e.user._id,poster:"",jEntry:e.body.jlEntry});e.isAuthenticated()?glTransaction.addGLTransaction(n,function(e){var r={};"1"==e.status?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/ap-vi",r.message="Document Number: "+e.docNumber+" saved!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Error!",o.send(r))}):(returnTo=e.url,o.redirect("/login"))}).patch().delete(),app.route("/rp-vd").get(async function(e,o){e.isAuthenticated()?(companyCode_list=await companyCode.getCompanyCode(),glAccount_list=await glAcc.getGlAccount(),glTransaction_List=await glTransaction.getGlTransaction(),vendor_List=await vendor.getVendor(),customer_List=await customer.getCustomer(),o.render("rp-vd",{user:e.user,companyCodes:companyCode_list,glAccounts:glAccount_list,transactionList:glTransaction_List,customers:customer_List,vendors:vendor_List})):(returnTo=e.url,o.redirect("/login"))}).post(function(e,o){const r={documentID:e.body.docID,documentValues:{documentDate:e.body.documentDate,postingDate:e.body.postingDate,reference:e.body.reference,amount:e.body.amount,text:e.body.text,companyCode:e.body.companyCode,companyName:e.body.companyName,currency:e.body.currency,debit:e.body.debit,credit:e.body.credit,transactionType:e.body.transactionType,status:"parked",parker:e.user._id,poster:"",jEntry:e.body.jlEntry}};e.isAuthenticated()?glTransaction.updateGLTransaction(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/rp-vd",r.message="Transaction Updated!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage=e,o.send(r))}):(returnTo=e.url,o.redirect("/login"))}).patch(function(e,o){const r={documentID:e.body.documentID,documentValues:{poster:e.user._id,status:"posted"}};e.isAuthenticated()?glTransaction.updateGLTransaction(r,function(e){var r={};"1"==e?(r.redirect=!0,r.redirectURL=process.env.BASE_URL+"/rp-vd",r.message="Transaction Posted!",o.send(r)):(r.redirect=!1,r.error=!0,r.errorMessage="Error!",o.send(r))}):(returnTo=e.url,o.redirect("/login"))}).delete(),app.route("/rp-vr").get(async function(e,o){e.isAuthenticated()?(glTransaction_List=await glTransaction.getGlTransaction(),companyCode_list=await companyCode.getCompanyCode(),vendor_List=await vendor.getVendor(),customer_List=await customer.getCustomer(),o.render("rp-vr",{user:e.user,glTransactions:glTransaction_List,companyCodes:companyCode_list,vendors:vendor_List,customers:customer_List})):(returnTo=e.url,o.redirect("/login"))}).post(),app.route("/rp-md").get(async function(e,o){e.isAuthenticated()?(glTransaction_List=await glTransaction.getGlTransaction(),companyCode_list=await companyCode.getCompanyCode(),vendor_List=await vendor.getVendor(),customer_List=await customer.getCustomer(),o.render("rp-md",{user:e.user,glTransactions:glTransaction_List,companyCodes:companyCode_list,vendors:vendor_List,customers:customer_List})):(returnTo=e.url,o.redirect("/login"))}).post(),app.route("/down").get(function(e,o){o.render("down",{user:e.user})}),app.listen(3e3,function(){console.log("Server started on port 3000")});